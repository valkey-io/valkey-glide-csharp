name: The OSS Review Toolkit (ORT)

permissions:
    contents: read
    pull-requests: write
    actions: read

on:
    create:
        ref_type: branch
        ref: "refs/heads/release-*"
    workflow_dispatch:
        inputs:
            branch_name:
                description: "The branch to run against the ORT tool"
                required: true
                default: "main"

jobs:
    run-ort:
        name: Create attribution files
        runs-on: ubuntu-latest

        # 1. For workflow_dispatch, always allow
        # 2. For pull_request, run if branch is not autogenerated ort-diff-for- branches
        if: >
            github.repository_owner == 'valkey-io' &&
            (github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'pull_request' && !startsWith(github.head_ref, 'ort-diff-for-')))

        env:
            ATTRIBUTIONS_FILE: "THIRD_PARTY_LICENSES"
            TARGET_BRANCH: ${{ github.event.inputs.branch_name }}
            EVENT_NAME: ${{ github.event_name }}
            HEAD_REF: ${{ github.head_ref }}

        steps:
            - name: Checkout target branch
              uses: actions/checkout@v4
              with:
                  submodules: true

            - name: Setup target commit
              run: |
                  echo "TARGET_COMMIT=`git rev-parse HEAD`" >> $GITHUB_ENV

            - name: Set up JDK 11 for the ORT package
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: 11

            - name: Cache ORT and Gradle packages
              uses: actions/cache@v4
              id: cache-ort
              with:
                  path: |
                      ./ort
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-ort

            - name: Checkout ORT Repository
              if: steps.cache-ort.outputs.cache-hit != 'true'
              uses: actions/checkout@v4
              with:
                  repository: "oss-review-toolkit/ort"
                  path: "./ort"
                  ref: "46.0.0"
                  submodules: recursive

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@1.85

            - name: Build and install ORT
              if: steps.cache-ort.outputs.cache-hit != 'true'
              working-directory: ./ort/
              run: |
                  export JAVA_OPTS="$JAVA_OPTS -Xmx8g"
                  ./gradlew installDist

            - name: Create ORT config file
              run: |
                  mkdir -p ~/.ort/config
                  cat << EOF > ~/.ort/config/config.yml
                  ort:
                    analyzer:
                      skip_excluded: true
                      allowDynamicVersions: true
                      enabledPackageManagers: [Cargo, NuGet]
                  EOF
                  cat ~/.ort/config/config.yml

            - name: Set up dotnet
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: |
                      6
                      8
                      9

            - name: Set up nuget-inspector
              run: |
                  wget -q https://github.com/aboutcode-org/nuget-inspector/releases/download/v0.9.12/nuget-inspector-v0.9.12-linux-x64.tar.gz
                  tar xf nuget-inspector-*.tar.gz
                  echo $GITHUB_WORKSPACE/nuget-inspector >> $GITHUB_PATH

              # Add SER, because >50% of glide C# client's code is copied from there for compatibility purposes
            - name: Add SER dependency
              working-directory: sources/Valkey.Glide
              run: |
                  dotnet add package StackExchange.Redis --version 2.8.58

            - name: Run ORT tools
              id: ort
              working-directory: ./ort/
              run: |
                  mkdir ort_results
                  # Analyzer (analyzer-result.json)
                  ./gradlew cli:run --args="--info analyze -i . -o ort_results -f JSON"
            
                  # NOTICE DEFAULT
                  ./gradlew cli:run --args="--info report -i ort_results/analyzer-result.json -o ort_results/ -f PlainTextTemplate"
            
            - name: Upload ORT results
              if: always()
              continue-on-error: true
              uses: actions/upload-artifact@v4
              with:
                  name: ort_results
                  path: |
                      ort_results/**

              ### Get licenses ###
            - name: Retrieve licenses list
              working-directory: valkey-glide/utils
              run: |
                  {
                    echo 'LICENSES_LIST<<EOF'
                    python3 get_licenses_from_ort.py
                    echo EOF
                  } >> "$GITHUB_ENV"

              ### Upload licenses ###
            - name: Get current date
              id: date
              run: |
                  CURR_DATE=$(date +'%Y-%m-%d-%H')
                  echo "date=${CURR_DATE}" >> $GITHUB_OUTPUT

            - name: Upload the final package list
              continue-on-error: true
              uses: actions/upload-artifact@v4
              with:
                  name: final-package-list-${{ steps.date.outputs.date }}
                  path: |
                      valkey-glide/utils/final_package_list.txt
                  retention-days: 30

            - name: Upload the skipped package list
              continue-on-error: true
              uses: actions/upload-artifact@v4
              with:
                  name: skipped-package-list-${{ steps.date.outputs.date }}
                  path: |
                      valkey-glide/utils/skipped_package_list.txt
                  retention-days: 30

            - name: Upload the unknown/unapproved package list
              continue-on-error: true
              uses: actions/upload-artifact@v4
              with:
                  name: unapproved-package-list-${{ steps.date.outputs.date }}
                  path: |
                      valkey-glide/utils/unapproved_package_list.txt
                  retention-days: 30

            - name: Check for unapproved packages
              run: |
                  if [ -s valkey-glide/utils/unapproved_package_list.txt ]; then
                    echo "::error::Found unapproved packages. Please review unapproved package list"
                    cat valkey-glide/utils/unapproved_package_list.txt
                    exit 1
                  else
                    echo "No unapproved packages found."
                  fi

              ### Check for ATTRIBUTIONS_FILE diff ###
            - name: Check for diff
              run: |
                  cp ort_results/NOTICE_DEFAULT $ATTRIBUTIONS_FILE
                  GIT_DIFF=`git diff $ATTRIBUTIONS_FILE`
                  if [ -n "$GIT_DIFF" ]; then
                    echo "FOUND_DIFF=true" >> $GITHUB_ENV
                  else
                    echo "FOUND_DIFF=false" >> $GITHUB_ENV
                  fi

              ### Create PR, Note a potential race on the source branch ###
            - name: Create pull request
              if: ${{ env.FOUND_DIFF  == 'true' && github.event_name != 'pull_request' }}
              run: |
                  export ORT_DIFF_BRANCH_NAME="ort-diff-for-$TARGET_BRANCH"
                  echo "Creating pull request from branch $ORT_DIFF_BRANCH_NAME to branch $TARGET_BRANCH"
                  git config --global user.email "valkey-glide@lists.valkey.io"
                  git config --global user.name "ort-bot"
                  git checkout -b ${ORT_DIFF_BRANCH_NAME}
                  git add $ATTRIBUTIONS_FILE
                  git commit -m "Updated attribution files" -s
                  git push --set-upstream origin ${ORT_DIFF_BRANCH_NAME} -f

                  # Check if PR already exists
                  existing_pr=$(gh pr list --base ${TARGET_BRANCH} --head ${ORT_DIFF_BRANCH_NAME} --json number --jq '.[0].number')

                  if [ -z "$existing_pr" ]; then
                    # Create a new PR if none exists
                    title="Updated attribution files for commit ${TARGET_COMMIT}"
                    gh pr create -B ${TARGET_BRANCH} -H ${ORT_DIFF_BRANCH_NAME} --title "${title}" --body "Created by Github action. ${{ env.LICENSES_LIST }}"
                    echo "Pull request created successfully."
                  else
                    # Update the existing PR
                    echo "Pull request #$existing_pr already exists. Updating branch."
                    gh pr edit $existing_pr --title "Updated attribution files for commit ${TARGET_COMMIT}" --body "Created by Github action. ${{ env.LICENSES_LIST }}"
                    echo "Pull request updated successfully."
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  INPUT_VERSION: ${{ github.event.inputs.version }}

              ### Warn of outdated ATTRIBUTIONS_FILE for PR ###
            - name: Warn of outdated ATTRIBUTIONS_FILE due to the PR
              if: ${{ env.FOUND_DIFF == 'true' && github.event_name == 'pull_request' }}
              run: |
                  MESSAGE="WARNING! The attribution files differ in this PR. Please ensure an updating PR is issued using a scheduled or manual run of this workflow!"

                  # Echo the message to the console
                  echo "$MESSAGE"

                  # Emit a general warning in the action log
                  echo "::warning::$MESSAGE"

                  if git diff --quiet $ATTRIBUTIONS_FILE; then
                    continue
                  else
                    # Emit a warning associated with the changed file
                    echo "::warning file=$FILE::WARNING! The attribution file differs in this PR."
                  fi
