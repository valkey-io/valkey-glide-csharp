name: Install Server

inputs:
    os:
        description: "The current operating system"
        required: true
        type: string
        options:
            - ubuntu
            - amazon-linux
            - macos
            - windows
    target:
        description: "Specified target for rust toolchain"
        required: true
        type: string
        options:
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - x86_64-apple-darwin
            - aarch64-apple-darwin
            - x86_64-pc-windows-msvc
            - aarch64-pc-windows-msvc
    server-version:
        description: "Server version to install"
        required: true
        type: string

env:
    CARGO_TERM_COLOR: always

runs:
    using: "composite"
    steps:
        - name: Set environment variables
          shell: bash
          env:
              OS: ${{ inputs.os }}
              SERVER_VERSION: ${{ inputs.server-version }}
          run: |
              echo "OS=$OS"                         >> $GITHUB_ENV
              echo "SERVER_VERSION=$SERVER_VERSION" >> $GITHUB_ENV

        # Environment variables must be passed into WSL explicitly using the WSLENV environment variable.
        # The '/p' flag translates the $GITHUB_ENV path from Windows to WSL format.
        - name: Pass environment variables to WSL
          if: ${{ inputs.os == 'windows' }}
          shell: bash
          run: |
              echo "WSLENV=SERVER_VERSION:GITHUB_ENV/p" >> $GITHUB_ENV

        - name: Determine Valkey source version
          shell: bash
          run: |
              # Fetch version.h directly from GitHub, then extract the version number from it.
              version_h=$(curl -fsSL "https://raw.githubusercontent.com/valkey-io/valkey/$SERVER_VERSION/src/version.h")
              source_version=$(echo "$version_h" | grep -E 'VALKEY_VERSION|REDIS_VERSION' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)

              if [[ -z "$source_version" ]]; then
                  echo "Error: Could not determine source version for Valkey $SERVER_VERSION"
                  exit 1
              fi

              echo "SOURCE_VERSION=$source_version" >> $GITHUB_ENV

        - name: Cache compiled Valkey binaries
          if: ${{ inputs.server-version >= '7.2' }}
          id: cache-valkey
          uses: actions/cache@v4
          with:
              path: |
                  valkey/src/valkey-cli
                  valkey/src/valkey-server
              key: valkey-${{ env.SOURCE_VERSION }}-${{ inputs.target }}

        - name: Build and install Valkey binaries from source
          if: ${{ steps.cache-valkey.outputs.cache-hit != 'true' }}
          shell: ${{ inputs.os == 'windows' && 'wsl-bash {0}' || 'bash' }}
          run: |
              git clone --depth 1 --branch "$SERVER_VERSION" --single-branch 'https://github.com/valkey-io/valkey.git'

              # Prior to Valkey 7.2, the binaries were named redis-cli and redis-server by default.
              cd valkey && make BUILD_TLS=yes REDIS_CLI_NAME=valkey-cli REDIS_SERVER_NAME=valkey-server install

        - name: Install Valkey binaries from cache
          if: ${{ steps.cache-valkey.outputs.cache-hit == 'true' }}
          shell: ${{ inputs.os == 'windows' && 'wsl-bash {0}' || 'bash' }}
          run: |
              sudo cp valkey/src/valkey-cli valkey/src/valkey-server /usr/local/bin

        - name: Verify Valkey installation
          shell: ${{ inputs.os == 'windows' && 'wsl-bash {0}' || 'bash' }}
          run: |
              if [ ! -f /usr/local/bin/valkey-cli ] || [ ! -f /usr/local/bin/valkey-server ]; then
                  echo "Error: Valkey installation failed."
                  exit 1
              else
                  echo "Installed Valkey:"
                  valkey-cli --version
                  valkey-server --version
              fi
