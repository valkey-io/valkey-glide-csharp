name: Install Server

inputs:
    os:
        description: "The current operating system"
        required: true
        type: string
        options:
            - ubuntu
            - amazon-linux
            - macos
            - windows
    target:
        description: "Specified target for rust toolchain"
        required: true
        type: string
        options:
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - x86_64-apple-darwin
            - aarch64-apple-darwin
            - x86_64-pc-windows-msvc
            - aarch64-pc-windows-msvc
    server-version:
        description: "Server version to install"
        required: true
        type: string

env:
    CARGO_TERM_COLOR: always

runs:
    using: "composite"
    steps:
        - name: Set environment variables
          shell: bash
          env:
              OS: ${{ inputs.os }}
              SERVER_VERSION: ${{ inputs.server-version }}
          run: |
              echo "OS=$OS"                         >> $GITHUB_ENV
              echo "SERVER_VERSION=$SERVER_VERSION" >> $GITHUB_ENV

        # Environment variables must be passed into WSL explicitly using the WSLENV environment variable.
        # The '/p' flag translates the $GITHUB_ENV path from Windows to WSL format.
        - name: Pass environment variables to WSL
          if: ${{ inputs.os == 'windows' }}
          shell: bash
          run: echo "WSLENV=SERVER_VERSION:GITHUB_ENV/p" >> $GITHUB_ENV

        - name: Checkout Valkey source code
          shell: ${{ inputs.os == 'windows' && 'wsl-bash {0}' || 'bash' }}
          run: |
              if [[ -d valkey ]]; then
                  echo 'Removing existing valkey directory...'
                  rm -fR valkey
              fi
              echo "Cloning and checking out Valkey $SERVER_VERSION"
              git clone --depth 1 --branch "$SERVER_VERSION" --single-branch 'https://github.com/valkey-io/valkey.git'

        - name: Determine Valkey source version
          shell: bash
          run: |
              cmd="cd valkey/src && grep -E 'VALKEY_VERSION|REDIS_VERSION' 'version.h' | grep -oE '[0-9]+\.[0-9]\.[0-9]' | head -1"

              # When running on Windows, we need to execute the commands inside WSL.
              if [[ "$OS" == "windows" ]]; then
                source_version=$(wsl bash -c "$cmd")
              else
                source_version=$(bash -c "$cmd")
              fi

              echo "SOURCE_VERSION=$source_version" >> $GITHUB_ENV

        - name: Cache compiled Valkey binaries
          id: cache-valkey
          uses: actions/cache@v4
          with:
              path: |
                  valkey/src/redis-cli
                  valkey/src/redis-server
              key: valkey-${{ env.SOURCE_VERSION }}-${{ inputs.target }}

        - name: Install cached Valkey binaries
          if: ${{ steps.cache-valkey.outputs.cache-hit == 'true' }}
          shell: ${{ inputs.os == 'windows' && 'wsl-bash {0}' || 'bash' }}
          run: |
              local_bin='/usr/local/bin'

              # Copy the cached binaries local bin.
              sudo cp 'valkey/src/redis-cli' 'valkey/src/redis-server' "$local_bin"

              # Create symbolic links for valkey-cli and valkey-server.
              sudo ln -sf "$local_bin/redis-cli"    "$local_bin/valkey-cli"
              sudo ln -sf "$local_bin/redis-server" "$local_bin/valkey-server"

              echo "Installed Valkey from cache:"
              valkey-cli --version
              valkey-server --version

        - name: Build and install Valkey binaries
          if: ${{ steps.cache-valkey.outputs.cache-hit != 'true' }}
          shell: ${{ inputs.os == 'windows' && 'wsl-bash {0}' || 'bash' }}
          run: |
              cd valkey
              make BUILD_TLS=yes
              sudo make install

              echo "Installed Valkey from source:"
              valkey-cli --version
              valkey-server --version
