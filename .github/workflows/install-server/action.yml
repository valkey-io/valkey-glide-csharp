name: Install Server

inputs:
    os:
        description: "The current operating system"
        required: true
        type: string
        options:
            - ubuntu
            - amazon-linux
            - macos
            - windows
    target:
        description: "Specified target for rust toolchain"
        required: true
        type: string
        options:
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - x86_64-apple-darwin
            - aarch64-apple-darwin
            - x86_64-pc-windows-msvc
            - aarch64-pc-windows-msvc
    server-version:
        description: "Server version to install"
        required: true
        type: string

env:
    CARGO_TERM_COLOR: always
    # Use the WSL bash shell on Windows.
    # See <https://github.com/Vampire/setup-wsl>
    SHELL: ${{ inputs.os == 'windows' && 'wsl-bash {0}' || 'bash' }}

runs:
    using: "composite"
    steps:
        - name: Setup Environment Variables
          shell: ${{ env.SHELL }}
          env:
              SERVER_VERSION: ${{ inputs.server-version }}
          run: echo "SERVER_VERSION=$SERVER_VERSION" >> $GITHUB_ENV

        - name: Prepare Valkey sources
          shell: ${{ env.SHELL }}
          run: |
              echo "Cloning and checking out Valkey $SERVER_VERSION"
              if [[ -d valkey ]]; then
                  echo "Removing existing valkey directory..."
                  rm -fR valkey
              fi
              git clone https://github.com/valkey-io/valkey.git
              cd valkey/src
              git checkout $SERVER_VERSION
              SOURCES_VERSION=`grep ' VALKEY_VERSION ' version.h | grep -o -E '[0-9]+\.[0-9]\.[0-9]'` || :
              if [[ -z $SOURCES_VERSION ]]; then
                  SOURCES_VERSION=`grep ' REDIS_VERSION ' version.h | grep -o -E '[0-9]+\.[0-9]\.[0-9]'`
              fi
              echo "SOURCES_VERSION=$SOURCES_VERSION" >> $GITHUB_ENV

        # TODO #184: Support caching for Windows.
        - name: Cache compiled Valkey binaries
          id: cache-valkey
          if: ${{ inputs.os != 'windows' }}
          uses: actions/cache@v4
          with:
              path: |
                  valkey/src/valkey-server
                  valkey/src/valkey-cli
              key: valkey-${{ env.SOURCES_VERSION }}-${{ inputs.target }}

        # Manual install, because makefile target rebuilds everything, we want to avoid that
        - name: Install cached Valkey binaries
          if: ${{ steps.cache-valkey.outputs.cache-hit == 'true' }}
          shell: ${{ env.SHELL }}
          run: |
              cd valkey/src
              if command -v sudo &> /dev/null
              then
                  echo "sudo command exists"
                  SUDO=sudo
              fi
              $SUDO cp valkey-server valkey-cli redis-server redis-cli /usr/local/bin/ 2>/dev/null || :
              if [[ ! -e /usr/local/bin/redis-server ]]; then
                  $SUDO cp valkey-server /usr/local/bin/redis-server
              fi
              echo 'export PATH=/usr/local/bin:$PATH' >>~/.bash_profile

        - name: Build and install Valkey binaries
          if: ${{ steps.cache-valkey.outputs.cache-hit != 'true' }}
          shell: ${{ env.SHELL }}
          run: |
              cd valkey
              make BUILD_TLS=yes
              if command -v sudo &> /dev/null
              then
                  echo "sudo command exists"
                  sudo make install
              else
                  echo "sudo command does not exist"
                  make install
              fi
              echo 'export PATH=/usr/local/bin:$PATH' >>~/.bash_profile
