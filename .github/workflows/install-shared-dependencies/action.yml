name: Install shared software dependencies

inputs:
    os:
        description: "The current operating system"
        required: true
        # See 'os-matrix.json'
        type: choice
        options:
            - ubuntu
            - amazon-linux
            - macos
            - windows
    target:
        description: "Specified target for rust toolchain"
        required: true
        # See 'os-matrix.json'
        type: choice
        options:
            - x86_64-unknown-linux-gnu
            - aarch64-unknown-linux-gnu
            - x86_64-apple-darwin
            - aarch64-apple-darwin
            - x86_64-pc-windows-msvc
            - aarch64-pc-windows-msvc
    server-version:
        description: "Server version to install"
        required: true
        # See 'server-matrix.json'
        type: choice
        options:
            - 9.0
            - 8.1
            - 8.0
            - 7.2
            - 7.0
            - 6.2
    github-token:
        description: "GITHUB_TOKEN, GitHub App installation access token"
        type: string

runs:
    using: "composite"
    steps:
        - name: Install software dependencies for macOS
          shell: bash
          if: "${{ inputs.os == 'macos' }}"
          run: |
              brew update
              brew install openssl coreutils

        - name: Install software dependencies for Ubuntu GNU
          shell: bash
          if: "${{ inputs.os == 'ubuntu' }}"
          run: |
              sudo apt update -y
              sudo apt install -y git gcc pkg-config openssl libssl-dev

        - name: Install software dependencies for Amazon-Linux
          shell: bash
          if: "${{ inputs.os == 'amazon-linux' }}"
          run: |
              yum install -y gcc pkgconfig openssl openssl-devel which curl gettext libasan tar --allowerasing

        # In Windows runners, the Valkey servers run within WSL.
        # These can be accessed via the WSL bash shell.
        # See <https://github.com/Vampire/setup-wsl> for more details.
        - name: Install software dependencies for Windows
          if: "${{ inputs.os == 'windows' }}"
          uses: Vampire/setup-wsl@v6
          with:
              distribution: Ubuntu-22.04
              additional-packages: python3 build-essential git pkg-config libssl-dev

        - name: Install Rust toolchain
          uses: ./.github/workflows/install-rust
          with:
              target: ${{ inputs.target }}
              github-token: ${{ inputs.github-token }}

        - name: Install server
          if: "${{ inputs.server-version }}"
          uses: ./.github/workflows/install-server
          with:
              os: ${{ inputs.os }}
              target: ${{ inputs.target }}
              server-version: ${{ inputs.server-version }}

        - name: Install zig
          if: ${{ contains(inputs.target, 'linux-gnu') }}
          uses: ./.github/workflows/install-zig
